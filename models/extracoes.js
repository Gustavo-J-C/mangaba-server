const { DataTypes } = require('sequelize');
const sequelize = require('../database');
const Arvore = require('./arvores');

const Extracao = sequelize.define('extracoes', {
  id: {
    type: DataTypes.BIGINT,
    primaryKey: true,
    autoIncrement: true
  },
  arvores_id: {
    type: DataTypes.BIGINT,
    allowNull: false,
    references: {
      model: 'arvores',
      key: 'id'
    }
  },
  vl_volume: {
    type: DataTypes.FLOAT,
    allowNull: false
  },
  created_at: {
    type: DataTypes.DATE,
    allowNull: false,
    defaultValue: DataTypes.NOW
  },
  updated_at: {
    type: DataTypes.DATE,
    allowNull: true,
    defaultValue: null
  },
  deleted_at: {
    type: DataTypes.DATE,
    allowNull: true,
    defaultValue: null
  }
}, {
  paranoid: true,
  underscored: true,
  tableName: 'extracoes'
});

// =============================================
// FUN√á√ïES UTILIT√ÅRIAS
// =============================================

/**
 * Atualiza a quantidade total de extra√ß√µes de uma √°rvore
 * @param {number} arvores_id - ID da √°rvore
 */
async function atualizarQtExtracoes(arvores_id) {
  const total = await Extracao.count({ where: { arvores_id } });
  console.log(`Atualizando qt_extracoes para √°rvore ID ${arvores_id}: ${total}`);
  
  // Importa√ß√£o tardia para evitar depend√™ncia circular
  const Arvore = require('./arvores');
  await Arvore.update(
    { qt_extracoes: total },
    { where: { id: arvores_id } }
  );
}

/**
 * Recalcula a m√©dia de tempo entre extra√ß√µes de uma √°rvore
 * @param {number} arvores_id - ID da √°rvore
 */
async function recalcularMediaTempoExtracoes(arvores_id) {
  const extracoes = await Extracao.findAll({
    where: { arvores_id, deleted_at: null },
    order: [['created_at', 'ASC']],
  });

  // Importa√ß√£o tardia para evitar depend√™ncia circular
  const Arvore = require('./arvores');

  // Se n√£o h√° extra√ß√µes suficientes para calcular m√©dia
  if (extracoes.length <= 1) {
    await Arvore.update(
      { md_tempo_extracoes: null },
      { where: { id: arvores_id } }
    );
    return;
  }

  // Calcula as diferen√ßas entre extra√ß√µes consecutivas
  let vl_total_extracoes = 0;
  const diferencasEmMs = [];
  for (let i = 0; i < extracoes.length; i++) {
    vl_total_extracoes += extracoes[i].vl_volume;
    console.log(`Vl_volume extra√ß√£o ${i}: ${extracoes[i].vl_volume}`);
    
    const diff = new Date(extracoes[i].created_at) - new Date(extracoes[i].created_at);
    diferencasEmMs.push(diff);
  }

  console.log(`Quantidade de extracoes: ${extracoes.length}, total volume: ${vl_total_extracoes}`);

  // Converte para dias e calcula a m√©dia
  const mediaMs = diferencasEmMs.reduce((acc, curr) => acc + curr, 0) / diferencasEmMs.length;
  const mediaDias = mediaMs / (1000 * 60 * 60 * 24);

  await Arvore.update(
    { md_tempo_extracoes: Math.round(mediaDias * 100) / 100,
      vl_total_extracoes,
      md_frutos: Math.round((vl_total_extracoes / extracoes.length) * 100) / 100
     }, // Arredonda para 2 casas decimais
    { where: { id: arvores_id } }
  );
}


/**
 * Executa todos os rec√°lculos necess√°rios ap√≥s mudan√ßa em extra√ß√µes
 * @param {number} arvores_id - ID da √°rvore
 */
async function recalcularEstatisticasArvore(arvores_id) {
  try {
    await Promise.all([
      atualizarQtExtracoes(arvores_id),
      recalcularMediaTempoExtracoes(arvores_id)
    ]);
    console.log(`‚úÖ Estat√≠sticas da √°rvore ${arvores_id} atualizadas com sucesso`);
  } catch (error) {
    console.error(`‚ùå Erro ao recalcular estat√≠sticas da √°rvore ${arvores_id}:`, error);
    throw error;
  }
}

// =============================================
// HOOKS DO SEQUELIZE
// =============================================

Extracao.beforeDestroy(async (extracao, options) => {
  console.log('üîç beforeDestroy disparado:', {
    id: extracao.id,
    arvores_id: extracao.arvores_id,
    force: options.force,
    paranoid: options.paranoid
  });
});

// Atualiza timestamp antes de modificar
Extracao.beforeUpdate(async (extracao, options) => {
  extracao.updated_at = new Date();
});

// Recalcula estat√≠sticas ap√≥s criar extra√ß√£o
Extracao.afterCreate(async (extracao, options) => {
  console.log(`üå± Nova extra√ß√£o criada para √°rvore ${extracao.arvores_id}`);
  await recalcularEstatisticasArvore(extracao.arvores_id);
});

// Recalcula estat√≠sticas ap√≥s remover extra√ß√£o
Extracao.afterDestroy(async (extracao, options) => {
  console.log(`üóëÔ∏è Extra√ß√£o removida da √°rvore ${extracao.arvores_id}`);
  await recalcularEstatisticasArvore(extracao.arvores_id);
});

// Recalcula estat√≠sticas ap√≥s atualizar extra√ß√£o (caso mude a √°rvore)
Extracao.afterUpdate(async (extracao, options) => {
  if (extracao.changed('arvores_id')) {
    console.log(`üîÑ Extra√ß√£o movida para √°rvore ${extracao.arvores_id}`);
    await recalcularEstatisticasArvore(extracao.arvores_id);
    
    // Se mudou de √°rvore, precisa recalcular a √°rvore anterior tamb√©m
    if (extracao._previousDataValues && extracao._previousDataValues.arvores_id) {
      await recalcularEstatisticasArvore(extracao._previousDataValues.arvores_id);
    }
  }
});

module.exports = Extracao;
